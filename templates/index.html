<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCOPD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
        }

        .container {
            max-width: 1000px;
        }

        .navbar {
            background-color: #f0f0f0;
            border-bottom: 1px solid #cccccc;
        }

        .navbar-brand {
            font-weight: bold;
            color: #000000;
        }

        .nav-link {
            color: #000000 !important;
        }

        .nav-link.active {
            font-weight: bold;
        }

        .card {
            border: 1px solid #cccccc;
            border-radius: 4px;
            box-shadow: none;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            font-weight: bold;
        }

        .form-control {
            border: 1px solid #cccccc;
            border-radius: 4px;
        }

        .btn-primary {
            background-color: #0066cc;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
        }

        .btn-primary:hover {
            background-color: #0052a3;
        }

        .result-card {
            background-color: #f0f8ff;
            border: 1px solid #0066cc;
            border-left: 4px solid #0066cc;
        }

        .error-card {
            background-color: #ffebee;
            border: 1px solid #d32f2f;
            border-left: 4px solid #d32f2f;
        }

        .feature-help {
            font-size: 12px;
            color: #666666;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #0066cc;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .welcome-section {
            background-color: #f0f8ff;
            border: 1px solid #0066cc;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .welcome-section h2 {
            font-size: 20px;
            font-weight: bold;
        }

        .alert {
            border-radius: 4px;
        }

        .nav-tabs {
            border-bottom: 1px solid #cccccc;
        }

        .nav-tabs .nav-link {
            border: 1px solid transparent;
            border-radius: 4px 4px 0 0;
        }

        .nav-tabs .nav-link.active {
            border: 1px solid #cccccc;
            border-bottom-color: #ffffff;
            background-color: #ffffff;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }
    </style>
</head>

<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">AutoCOPD</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" data-target="home" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-target="common-analysis" href="#">Common Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-target="custom-analysis" href="#">Custom Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-target="personal-analysis" href="#">Personal Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-target="introduction" href="#">Introduction</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-3 mb-5">
        <!-- Home 页面 -->
        <div id="home" class="content-section active">
            <div class="welcome-section">
                <h2>Welcome to the Shiny App for COPD Screening</h2>
                <p>You can use it to accurately predict the risk of COPD in undiagnosed subjects.</p>
                <p>This App supports both file upload and manual input for importing data to make predictions. Please
                    refer
                    to the example files for the data format.</p>
                <p><strong>Note:</strong> AutoCOPD is only used for auxiliary diagnosis of COPD, and the final
                    interpretation needs to be determined by doctor. If you have any questions, please do not hesitate
                    to
                    email: lfj@stu.gzhmu.edu.cn.</p>
            </div>

            {% if not model_loaded %}
            <div class="alert alert-danger" role="alert">
                警告：模型加载失败，请先运行模型训练流程！
            </div>
            {% endif %}

            <!-- 模型信息 -->
            <div class="card mt-5 p-4">
                <h3 class="card-title mb-3">模型信息</h3>
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="h5">模型参数</h4>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">模型类型：XGBoost分类器</li>
                            <li class="list-group-item">预测阈值：0.352（基于论文研究）</li>
                            <li class="list-group-item">特征数量：{{ features|length }}个QCT特征</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h4 class="h5">预测特征</h4>
                        <ul class="list-group list-group-flush">
                            {% for feature in features %}
                            <li class="list-group-item">{{ feature }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="mt-4 alert alert-info">
                    <p class="mb-0">参考论文：多中心慢阻肺CT筛查研究（AutoCOPD）</p>
                    <p class="mb-0">模型性能：多队列AUC 0.860-0.915</p>
                </div>
            </div>
        </div>

        <!-- Common Analysis 页面 -->
        <div id="common-analysis" class="content-section">
            <div class="card p-4">
                <h3 class="card-title mb-4">Common Analysis</h3>
                <form id="batchForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="csvFile" class="form-label">Choose .csv/.txt File</label>
                        <input type="file" class="form-control" id="csvFile" name="file" accept=".csv,.txt" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Separator</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="separator" id="comma" value=","
                                    checked>
                                <label class="form-check-label" for="comma">Comma</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="separator" id="tab" value="\t">
                                <label class="form-check-label" for="tab">Tab</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="display" id="head" value="head"
                                    checked>
                                <label class="form-check-label" for="head">Head</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="display" id="all" value="all">
                                <label class="form-check-label" for="all">All</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="#" class="text-primary">Example_data.csv</a>
                    </div>
                    <div class="alert alert-info mt-3">
                        <p class="mb-0">Note: Missing data will be imputed by R package missForest (All data missing
                            completely will be excluded).</p>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-4" {% if not model_loaded %}disabled{% endif
                        %}>
                        开始批量预测
                    </button>
                </form>
                <div class="loading" id="batchLoading">
                    <div class="spinner"></div>
                    <p class="mt-2">批量预测中，请稍候...</p>
                </div>
            </div>
        </div>

        <!-- Custom Analysis 页面 -->
        <div id="custom-analysis" class="content-section">
            <div class="card p-4">
                <h3 class="card-title mb-4">Custom Analysis</h3>
                <form id="customForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="customCsvFile" class="form-label">Choose .csv/.txt File</label>
                        <input type="file" class="form-control" id="customCsvFile" name="file" accept=".csv,.txt"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Separator</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="separator" id="customComma" value=","
                                    checked>
                                <label class="form-check-label" for="customComma">Comma</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="separator" id="customTab" value="\t">
                                <label class="form-check-label" for="customTab">Tab</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="display" id="customHead" value="head"
                                    checked>
                                <label class="form-check-label" for="customHead">Head</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="display" id="customAll" value="all">
                                <label class="form-check-label" for="customAll">All</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="#" class="text-primary">Example_data.csv</a>
                    </div>
                    <div class="alert alert-info mt-3">
                        <p class="mb-0">Note: Your tag must contain two groups. Missing data will be imputed by R
                            package missForest (All data missing completely will be excluded).</p>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-4" {% if not model_loaded %}disabled{% endif
                        %}>
                        开始分析
                    </button>
                </form>
                <div class="loading" id="customLoading">
                    <div class="spinner"></div>
                    <p class="mt-2">分析中，请稍候...</p>
                </div>
                <div class="mt-4" id="customResult" style="display: none;">
                    <div class="card result-card p-4">
                        <h4 class="card-title mb-3">分析结果</h4>
                        <div id="customResultContent"></div>
                    </div>
                </div>
                <div class="mt-4" id="customError" style="display: none;">
                    <div class="card error-card p-4">
                        <h4 class="card-title mb-3">错误信息</h4>
                        <p id="customErrorMessage"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Analysis 页面 -->
        <div id="personal-analysis" class="content-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-4">
                        <h3 class="card-title mb-4">Personal Analysis</h3>
                        <form id="individualForm">
                            <div class="form-group">
                                <label for="whole_lung_LAA950" class="form-label">LAA-950 lung (%):</label>
                                <input type="number" class="form-control" id="whole_lung_LAA950"
                                    name="whole_lung_LAA950" step="0.001" min="0" max="100">
                                <small class="feature-help">请输入数值 (0-100)</small>
                            </div>
                            <div class="form-group">
                                <label for="whole_lung_LAA910" class="form-label">LAA-910 lung (%):</label>
                                <input type="number" class="form-control" id="whole_lung_LAA910"
                                    name="whole_lung_LAA910" step="0.001" min="0" max="100">
                                <small class="feature-help">请输入数值 (0-100)</small>
                            </div>
                            <div class="form-group">
                                <label for="left_upper_lobe_LAA950" class="form-label">LAA-950 left upper lobe
                                    (%):</label>
                                <input type="number" class="form-control" id="left_upper_lobe_LAA950"
                                    name="left_upper_lobe_LAA950" step="0.001" min="0" max="100">
                                <small class="feature-help">请输入数值 (0-100)</small>
                            </div>
                            <div class="form-group">
                                <label for="left_lower_lobe_LAA950" class="form-label">LAA-950 left lower lobe
                                    (%):</label>
                                <input type="number" class="form-control" id="left_lower_lobe_LAA950"
                                    name="left_lower_lobe_LAA950" step="0.001" min="0" max="100">
                                <small class="feature-help">请输入数值 (0-100)</small>
                            </div>
                            <div class="form-group">
                                <label for="right_upper_lobe_LAA950" class="form-label">LAA-950 right upper lobe
                                    (%):</label>
                                <input type="number" class="form-control" id="right_upper_lobe_LAA950"
                                    name="right_upper_lobe_LAA950" step="0.001" min="0" max="100">
                                <small class="feature-help">请输入数值 (0-100)</small>
                            </div>
                            <div class="form-group">
                                <label for="right_middle_lobe_LAA950" class="form-label">LAA-950 right middle lobe
                                    (%):</label>
                                <input type="number" class="form-control" id="right_middle_lobe_LAA950"
                                    name="right_middle_lobe_LAA950" step="0.001" min="0" max="100">
                                <small class="feature-help">请输入数值 (0-100)</small>
                            </div>
                            <div class="form-group">
                                <label for="right_lower_lobe_LAA950" class="form-label">LAA-950 right lower lobe
                                    (%):</label>
                                <input type="number" class="form-control" id="right_lower_lobe_LAA950"
                                    name="right_lower_lobe_LAA950" step="0.001" min="0" max="100">
                                <small class="feature-help">请输入数值 (0-100)</small>
                            </div>
                            <div class="form-group">
                                <label for="left_lower_lobe_LAA910" class="form-label">LAA-910 left lower lobe
                                    (%):</label>
                                <input type="number" class="form-control" id="left_lower_lobe_LAA910"
                                    name="left_lower_lobe_LAA910" step="0.001" min="0" max="100">
                                <small class="feature-help">请输入数值 (0-100)</small>
                            </div>
                            <div class="form-group">
                                <label for="right_lower_lobe_LAA910" class="form-label">LAA-910 right lower lobe
                                    (%):</label>
                                <input type="number" class="form-control" id="right_lower_lobe_LAA910"
                                    name="right_lower_lobe_LAA910" step="0.001" min="0" max="100">
                                <small class="feature-help">请输入数值 (0-100)</small>
                            </div>
                            <div class="form-group">
                                <label for="bronchus_WT" class="form-label">Lumen1 max diameter (mm):</label>
                                <input type="number" class="form-control" id="bronchus_WT" name="bronchus_WT"
                                    step="0.001" min="0">
                                <small class="feature-help">请输入数值</small>
                            </div>
                            <div class="form-group">
                                <label for="bronchus_LD" class="form-label">Lumen4 average diameter (mm):</label>
                                <input type="number" class="form-control" id="bronchus_LD" name="bronchus_LD"
                                    step="0.001" min="0">
                                <small class="feature-help">请输入数值</small>
                            </div>
                            <div class="alert alert-info mt-3">
                                <p class="mb-0">Note: You need input at least one feature value ranging from 0 to
                                    100.</p>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 mt-4" {% if not model_loaded %}disabled{%
                                endif %}>
                                开始预测
                            </button>
                        </form>
                        <div class="loading" id="individualLoading">
                            <div class="spinner"></div>
                            <p class="mt-2">预测中，请稍候...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-4 result-card" id="individualResult" style="display: none;">
                        <h3 class="card-title mb-4">预测结果</h3>
                        <div class="mb-3">
                            <label class="form-label">COPD预测概率：</label>
                            <p id="predictedProbability" class="form-control-plaintext font-weight-bold"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">诊断结果：</label>
                            <p id="diagnosisResult" class="form-control-plaintext font-weight-bold"></p>
                        </div>
                        <div class="alert alert-info mt-3">
                            <p class="mb-0">说明：预测阈值为0.352（基于论文研究）</p>
                            <p class="mb-0">- 概率 ≥ 0.352：COPD高风险</p>
                            <p class="mb-0">- 概率 < 0.352：COPD低风险</p>
                        </div>
                    </div>
                    <div class="card p-4 error-card" id="individualError" style="display: none;">
                        <h3 class="card-title mb-4">错误信息</h3>
                        <p id="errorMessage"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Introduction 页面 -->
        <div id="introduction" class="content-section">
            <div class="card p-4">
                <h3 class="card-title mb-4">Introduction</h3>
                <p>AutoCOPD is a Shiny App for COPD Screening based on multi-center COPD CT screening study.</p>
                <p>The app uses machine learning models to predict the risk of COPD in undiagnosed subjects based on
                    CT-derived features.</p>
                <p>Key features:</p>
                <ul>
                    <li>Personal Analysis: Predict COPD risk for individual subjects</li>
                    <li>Common Analysis: Batch predict COPD risk for multiple subjects</li>
                    <li>Custom Analysis: Customize analysis parameters (under development)</li>
                </ul>
                <p>For more information, please refer to the original paper.</p>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // 导航栏切换功能
            $('.nav-link').click(function (e) {
                e.preventDefault();

                // 移除所有导航项的active类
                $('.nav-link').removeClass('active');
                // 添加当前导航项的active类
                $(this).addClass('active');

                // 隐藏所有内容区域
                $('.content-section').removeClass('active');
                // 显示目标内容区域
                var target = $(this).data('target');
                $('#' + target).addClass('active');
            });

            // 个体预测表单提交
            $('#individualForm').submit(function (e) {
                e.preventDefault();

                // 显示加载动画
                $('#individualLoading').show();
                $('#individualResult').hide();
                $('#individualError').hide();

                // 收集表单数据
                var formData = {};
                formData['whole_lung_LAA950'] = parseFloat($('#whole_lung_LAA950').val()) || 0;
                formData['whole_lung_LAA910'] = parseFloat($('#whole_lung_LAA910').val()) || 0;
                formData['bronchus_WT'] = parseFloat($('#bronchus_WT').val()) || 0;
                formData['bronchus_LD'] = parseFloat($('#bronchus_LD').val()) || 0;

                // 发送AJAX请求
                $.ajax({
                    url: '/predict',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        // 隐藏加载动画
                        $('#individualLoading').hide();

                        // 显示结果
                        $('#predictedProbability').text(response.predicted_probability);
                        $('#diagnosisResult').text(response.diagnosis);
                        $('#individualResult').show();
                    },
                    error: function (xhr) {
                        // 隐藏加载动画
                        $('#individualLoading').hide();

                        // 显示错误信息
                        var errorMessage = xhr.responseJSON ? xhr.responseJSON.error : '预测失败，请重试';
                        $('#errorMessage').text(errorMessage);
                        $('#individualError').show();
                    }
                });
            });

            // 批量预测表单提交
            $('#batchForm').submit(function (e) {
                e.preventDefault();

                // 显示加载动画
                $('#batchLoading').show();

                // 创建FormData对象
                var formData = new FormData(this);

                // 发送AJAX请求
                $.ajax({
                    url: '/batch_predict',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response, status, xhr) {
                        // 隐藏加载动画
                        $('#batchLoading').hide();

                        // 检查响应类型
                        var contentType = xhr.getResponseHeader('Content-Type');
                        if (contentType && contentType.includes('text/csv')) {
                            // 创建下载链接
                            var blob = new Blob([response], { type: 'text/csv;charset=utf-8;' });
                            var url = URL.createObjectURL(blob);
                            var link = document.createElement('a');
                            link.setAttribute('href', url);
                            link.setAttribute('download', 'batch_predict_results.csv');
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        } else {
                            // 显示错误信息
                            alert('预测失败：' + (response.error || '未知错误'));
                        }
                    },
                    error: function (xhr) {
                        // 隐藏加载动画
                        $('#batchLoading').hide();

                        // 显示错误信息
                        var errorMessage = xhr.responseJSON ? xhr.responseJSON.error : '批量预测失败，请重试';
                        alert('错误：' + errorMessage);
                    }
                });
            });

            // 自定义分析表单提交
            $('#customForm').submit(function (e) {
                e.preventDefault();

                // 显示加载动画
                $('#customLoading').show();
                $('#customResult').hide();
                $('#customError').hide();

                // 创建FormData对象
                var formData = new FormData(this);

                // 发送AJAX请求
                $.ajax({
                    url: '/custom_analysis',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        // 隐藏加载动画
                        $('#customLoading').hide();

                        // 显示结果
                        var resultHtml = `
                            <div class="mb-4">
                                <h5>统计信息</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">总样本数：${response.total_samples}</li>
                                    <li class="list-group-item">COPD高风险：${response.high_risk_count} (${response.high_risk_rate}%)</li>
                                    <li class="list-group-item">COPD低风险：${response.low_risk_count}</li>
                                </ul>
                            </div>
                            <div class="mb-4">
                                <h5>样本数据（前10条）</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>序号</th>
                                                <th>预测概率</th>
                                                <th>诊断结果</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${response.sample_data.map((item, index) => `
                                                <tr>
                                                    <td>${index + 1}</td>
                                                    <td>${item.predicted_probability}</td>
                                                    <td>${item.diagnosis}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        $('#customResultContent').html(resultHtml);
                        $('#customResult').show();
                    },
                    error: function (xhr) {
                        // 隐藏加载动画
                        $('#customLoading').hide();

                        // 显示错误信息
                        var errorMessage = xhr.responseJSON ? xhr.responseJSON.error : '分析失败，请重试';
                        $('#customErrorMessage').text(errorMessage);
                        $('#customError').show();
                    }
                });
            });
        });
    </script>
</body>

</html>